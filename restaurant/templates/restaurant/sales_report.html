{% extends "customer/base.html" %}
{% load pluck %}
{% block content %}
<div class="container mt-4">
  <h2>Sales Report</h2>

  <div class="mt-4">
    <p><strong>Total Orders:</strong> {{ total_orders }}</p>
    <p><strong>Total Revenue:</strong> ₹{{ total_sales }}</p>
  </div>

  <h4 class="mt-4">Orders by Status</h4>
  <ul>
    {% for s in status_breakdown %}
      <li>{{ s.status }}: {{ s.count }}</li>
    {% endfor %}
  </ul>

  <canvas id="statusChart" height="100" class="mt-4 mb-5"></canvas>

  <h4 class="mt-4">Daily Sales</h4>
  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Total Sales</th>
      </tr>
    </thead>
    <tbody>
      {% for row in daily_sales %}
      <tr>
        <td>{{ row.date }}</td>
        <td>₹{{ row.total }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <canvas id="dailySalesChart" height="100" class="mt-4 mb-5"></canvas>

  <h4 class="mt-4">Payment Methods Distribution</h4>
  <canvas id="paymentPieChart" width="400" height="400" class="mb-5"></canvas>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Chart Scripts -->
<script>
  // Status Bar Chart
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  new Chart(statusCtx, {
    type: 'bar',
    data: {
      labels: {{ status_labels|safe }},
      datasets: [{
        label: '# of Orders',
        data: {{ status_counts|safe }},
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // Daily Sales Line Chart
  const salesCtx = document.getElementById('dailySalesChart').getContext('2d');
  new Chart(salesCtx, {
    type: 'line',
    data: {
      labels: {{ date_labels|safe }},
      datasets: [{
        label: 'Sales (₹)',
        data: {{ date_totals|safe }},
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // Payment Method Pie Chart
  const paymentCtx = document.getElementById('paymentPieChart').getContext('2d');
  new Chart(paymentCtx, {
    type: 'pie',
    data: {
      labels: {{ payment_data|pluck:"payment_method"|safe }},
      datasets: [{
        label: 'Payment Methods',
        data: {{ payment_data|pluck:"count"|safe }},
        backgroundColor: [
          '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'
        ],
        borderColor: '#fff',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true
    }
  });
</script>
{% endblock %}
